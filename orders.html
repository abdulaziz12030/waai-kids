<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>الطلبات | واعي كيدز</title>
  <meta name="description" content="اختر بوكس أولاد أو بنات، حدّد الكمية، أضف بطاقة إهداء (اختياري)، واختر طريقة الشحن داخل الرياض، ثم أدخل بيانات التوصيل. يظهر الإجمالي وزر الإجراء أسفل الصفحة." />
  <meta name="theme-color" content="#4C7AF2"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#4C7AF2; --bg2:#6B8EF7; --acc:#FF7AB6; --muted:#F4F7FF; --text:#1F2333; --white:#fff; --shadow:0 10px 25px rgba(76,122,242,.16); --cardShadow:0 16px 40px rgba(31,35,51,.10); --r:18px; }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:'Cairo',system-ui,-apple-system,sans-serif;color:var(--text);background:linear-gradient(180deg,#fafcff,#f6f8ff 40%,#fbfcff)}
    a{color:inherit;text-decoration:none}
    img{max-width:100%;display:block}

    .nav{position:sticky;top:0;z-index:60;backdrop-filter:saturate(140%) blur(8px);background:rgba(255,255,255,.9);border-bottom:1px solid #e9eeff}
    .nav .wrap{max-width:1200px;margin:auto;display:flex;align-items:center;gap:12px;padding:12px 18px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;color:var(--bg)}
    .brand img{height:36px;width:auto}
    .links{margin-inline-start:auto;display:flex;gap:18px;font-weight:700}
    .btn{background:var(--bg);color:#fff;border:none;border-radius:14px;padding:10px 16px;font-weight:800;cursor:pointer;box-shadow:var(--shadow);transition:.25s}
    .btn:hover{transform:translateY(-1px);background:#3f69ea}
    .btn-ghost{background:rgba(76,122,242,.15);border:1px solid rgba(255,255,255,.35);color:#1840b2}

    .section{max-width:1200px;margin:30px auto;padding:0 18px}
    .section h1,.section h2{font-size:clamp(22px,3vw,32px);margin:0 0 14px;font-weight:800;color:var(--bg)}

    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:18px}
    @media (max-width:1024px){ .grid{grid-template-columns:1fr} }

    .panel{background:#fff;border-radius:var(--r);box-shadow:var(--cardShadow);padding:18px;border:1px solid #eef2ff}
    .line{height:1px;background:#e9eeff;margin:12px 0}
    .muted{color:#5d6a8d}

    .cart-item{display:grid;grid-template-columns:120px 1fr auto;gap:12px;align-items:center}
    .mini-slider{position:relative;aspect-ratio:1/1;border-radius:12px;overflow:hidden;background:#f6f8ff}
    .mini-slider::after{content:"";position:absolute;inset:8px;border-radius:12px;pointer-events:none;box-shadow:inset 0 0 0 1px rgba(76,122,242,.08)}
    .mini-slider img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0;transform:scale(1.04);transition:opacity .7s ease,transform .6s cubic-bezier(.2,.7,.3,1)}
    .mini-slider img.active{opacity:1;transform:scale(1.10)}

    .cart-item .name{font-weight:800;color:#223}
    .opt{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .opt input{accent-color:var(--bg)}
    .qty{display:flex;align-items:center;gap:8px;margin-top:8px}
    .qty input{width:90px;border:1px solid #dfe7ff;border-radius:10px;padding:8px 10px}

    .form{display:grid;gap:10px}
    .inp{display:flex;flex-direction:column;gap:6px}
    .inp input,.inp select,.inp textarea{border:1px solid #dfe7ff;border-radius:12px;padding:12px 14px;font-size:1rem;outline:none;background:#fbfdff}
    .inp input:focus,.inp select:focus,.inp textarea:focus{border-color:var(--bg)}
    .success,.error{display:none;margin-top:8px;padding:10px 12px;border-radius:10px;font-weight:700}
    .success{background:#e8fff7;color:#0a6b52;border:1px solid #baf0df}
    .error{background:#fff1f1;color:#8b1d1d;border:1px solid #f1cccc}

    /* الشحن */
    .ship{display:grid;gap:12px}
    .ship .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:1024px){ .ship .row{grid-template-columns:1fr} }
    .chip{display:inline-flex;align-items:center;gap:8px;background:#f2f6ff;border:1px solid #e2e9ff;color:#2643a1;padding:8px 12px;border-radius:999px;font-weight:800}
    .shipOpt{display:flex;gap:12px;align-items:flex-start;border:1px solid #e9eeff;background:#fff;border-radius:14px;padding:12px}
    .shipOpt input{accent-color:var(--bg);margin-top:4px}
    .shipOpt .meta{font-size:.92rem;color:#3a466a}
    .shipOpt .title{font-weight:800;color:#1f2a5c}
    .ship-note{background:#f9fbff;border:1px dashed #cfe0ff;border-radius:12px;padding:10px 12px}

    /* ملخص أسفل الصفحة */
    .summary{position:sticky;bottom:0;z-index:50;background:rgba(255,255,255,.98);backdrop-filter:blur(6px);border:1px solid #e6ecff;border-radius:16px;box-shadow:0 12px 28px rgba(76,122,242,.12);padding:12px}
    .summary .row{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .summary .meta{font-weight:800;color:#233}
    .summary .total{font-weight:900;font-size:1.1rem}
    .summary .cta{display:flex;gap:8px;flex-wrap:wrap}

    footer{margin-top:40px;background:#2746b8;color:#e7ecff}
    footer .wrap{max-width:1200px;margin:auto;padding:18px;display:flex;justify-content:space-between;align-items:center;gap:12px}

    .wa{position:fixed;left:16px;bottom:16px;z-index:70}
    .wa a{display:grid;place-items:center;width:58px;height:58px;border-radius:50%;background:#25D366;box-shadow:0 12px 30px rgba(12,151,79,.28)}
    .wa svg{width:30px;height:30px;display:block}
    @media (max-width:640px){ .links{display:none} }
  </style>
</head>
<body>
  <!-- ترويسة -->
  <header class="nav">
    <div class="wrap">
      <a href="index.html" class="brand" aria-label="العودة للرئيسية">
        <img src="assets/logo/waai-kids-logo.png" alt="شعار واعي كيدز" width="160" height="36">
        <div class="title">واعي كيدز — صفحة الطلبات</div>
      </a>
      <nav class="links" aria-label="روابط رئيسية">
        <a href="index.html#services">البوكسات</a>
        <a href="#gift">بطاقة الإهداء</a>
      </nav>
    </div>
  </header>

  <main class="section">
    <h1>السلة وبيانات الطلب</h1>
    <div class="grid">
      <!-- يسار: السلة + الشحن + البطاقة + التوصيل -->
      <div class="panel">
        <h2 style="margin-top:0">سلة الشراء</h2>

        <!-- المنتج + سلايدر مصغّر -->
        <div class="cart-item" id="cartItem">
          <div class="mini-slider" id="itemSlider" aria-label="صور المنتج المختار">
            <img id="imgA" class="active" alt="بوكس هدية أولاد - صورة 1" src="assets/boxes/boy-1-600.webp" width="600" height="600" loading="lazy" decoding="async">
            <img id="imgB" alt="بوكس هدية أولاد - صورة 2" src="assets/boxes/boy-2-600.webp" width="600" height="600" loading="lazy" decoding="async">
          </div>

          <div>
            <div class="name" id="itemName">بوكس هدية أولاد</div>
            <div class="opt">
              <label><input type="radio" name="variant" value="boy" checked> أولاد (199 ر.س)</label>
              <label><input type="radio" name="variant" value="girl"> بنات (209 ر.س)</label>
            </div>
            <div class="qty"><label>الكمية: <input id="qty" type="number" min="1" value="1" step="1"></label></div>
            <div class="muted">بطاقة الإهداء بالأسفل (اختياري).</div>
          </div>

          <div style="text-align:end">
            <div style="font-weight:800;color:#243">السعر للوحدة</div>
            <div id="unitPrice" style="font-weight:800">199 ر.س</div>
          </div>
        </div>

        <div class="line"></div>

        <!-- الشحن داخل الرياض -->
        <section aria-label="خيارات الشحن داخل الرياض" class="ship">
          <h3 style="margin:4px 0 6px">الشحن داخل الرياض</h3>
          <div class="row">
            <label class="shipOpt">
              <input type="radio" name="shipping" value="aramex" id="ship_aramex" checked>
              <div>
                <div class="title">أرامكس — خلال <b>3 أيام عمل</b></div>
                <div class="meta">تسليم آمن إلى باب البيت. خيار عملي للطلبات غير العاجلة.</div>
                <div class="chip" aria-hidden="true">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="#2643a1" stroke-width="1.5"/><path d="M12 7v5l3 2" stroke="#2643a1" stroke-width="1.5" stroke-linecap="round"/></svg>
                  3 أيام عمل
                </div>
              </div>
            </label>

            <label class="shipOpt">
              <input type="radio" name="shipping" value="express" id="ship_express">
              <div>
                <div class="title">التوصيل السريع — مندوب كيدز خلال <b>24 ساعة</b></div>
                <div class="meta">للزيارات العاجلة والمناسبات السريعة — تسليم بنفس روح الهدية.</div>
                <div class="chip" aria-hidden="true">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M13 2 3 14h7l-1 8 10-12h-7l1-8Z" fill="#2643a1"/></svg>
                  خلال 24 ساعة
                </div>
              </div>
            </label>
          </div>

          <div id="shipNote" class="ship-note">
            ✅ تم اختيار: <strong>أرامكس</strong> — التوصيل خلال 3 أيام عمل.
          </div>
          <small class="muted">* المدد تقديرية وقد تختلف بحسب الأحياء وحالة الطرق. خارج الرياض: قريبًا.</small>
        </section>

        <div class="line"></div>

        <!-- بطاقة الإهداء -->
        <div class="panel" id="gift" style="padding:0;border:none;box-shadow:none;">
          <h2 style="margin:0 0 10px">بطاقة الإهداء (اختياري)</h2>
          <label style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
            <input type="checkbox" id="giftToggle"> أريد إضافة بطاقة إهداء ومعاينتها
          </label>
          <div id="giftArea" style="display:none">
            <div class="gift-wrap" style="display:grid;grid-template-columns:1fr 1fr;gap:18px">
              <div>
                <div class="form">
                  <div class="inp"><label>المستلم<input id="toInput" type="text" placeholder="إلى: أمير/أميرة صغيرة" maxlength="28"></label></div>
                  <div class="inp"><label>رسالة المعايدة<textarea id="msgInput" rows="4" placeholder="اكتب معايدتك الجميلة هنا" maxlength="180"></textarea></label><div class="muted"><span id="count">0</span>/180</div></div>
                  <div class="inp"><label>المُرسل<input id="fromInput" type="text" placeholder="من: عائلتك/اسمك" maxlength="28"></label></div>
                  <div class="inp"><label>نمط البطاقة<select id="themeSelect"><option value="boy">أولاد (أزرق)</option><option value="girl">بنات (وردي)</option></select></label></div>
                  <div style="display:flex;gap:8px;flex-wrap:wrap">
                    <button type="button" class="btn" id="printBtn">طباعة/حفظ PDF</button>
                    <button type="button" class="btn btn-ghost" id="copyBtn">نسخ النص</button>
                  </div>
                  <p class="muted">الطباعة تطبع البطاقة فقط بشكل أنيق. جرّب الإيموجي 🎈🎁✨</p>
                </div>
              </div>
              <div class="preview-wrap" id="cardPrintArea" style="display:grid;place-items:center;background:var(--muted);border-radius:18px;padding:12px">
                <div id="card" class="gift-card pattern-boy" style="width:min(100%,560px);aspect-ratio:7/4;position:relative;border-radius:18px;padding:22px;display:flex;flex-direction:column;justify-content:space-between;box-shadow:0 18px 40px rgba(76,122,242,.18);overflow:hidden;background:linear-gradient(135deg,#eaf2ff,#f7f9ff);">
                  <div class="brand" style="display:flex;align-items:center;gap:8px;font-weight:800;color:var(--bg)">
                    <svg viewBox="0 0 24 24" fill="none" width="22" height="22"><path d="M3 8h18v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8Z" stroke="currentColor" stroke-width="1.5"/><path d="M3 8h18M12 4v16M7.5 4c1.5 0 3 1.5 3 3H4.5c0-1.5 1.5-3 3-3Zm9 0c-1.5 0-3 1.5-3 3h6c0-1.5-1.5-3-3-3Z" stroke="currentColor" stroke-width="1.5"/></svg>
                    واعي كيدز
                  </div>
                  <div class="title" id="toTxt" style="font-size:clamp(18px,2.3vw,28px);font-weight:800;color:#243;margin:6px 0">إلى أميرنا الصغير 💙</div>
                  <div class="body" id="msgTxt" style="font-size:clamp(14px,1.6vw,18px);line-height:1.8;color:#334">نتمنى لك أيامًا سعيدة مليئة بالمرح! 🎉</div>
                  <div class="footer" style="display:flex;justify-content:space-between;align-items:center;font-weight:800">
                    <div class="from" id="fromTxt" style="opacity:.9">من: عائلتك</div>
                    <div class="ribbon" style="position:absolute;inset:auto 0 0 0;height:10px;background:linear-gradient(90deg,var(--bg),var(--bg2));"></div>
                  </div>
                </div>
              </div>
            </div>
          </div> <!-- /giftArea -->
        </div>

        <div class="line"></div>

        <!-- بيانات التوصيل -->
        <h3>بيانات التوصيل</h3>
        <form id="orderForm" class="form" onsubmit="return submitOrder(event)" data-endpoint="https://formspree.io/f/yourKidsOrdersEndpoint" novalidate>
          <div class="inp"><label>الاسم الكامل<input name="name" required placeholder="الاسم"></label></div>
          <div class="inp"><label>المدينة<input name="city" required placeholder="مثال: الرياض"></label></div>
          <div class="inp"><label>الحي<input name="district" required placeholder="مثال: الياسمين"></label></div>
          <div class="inp"><label>رقم الجوال<input name="phone" type="tel" required placeholder="05xxxxxxxx" inputmode="tel" pattern="^05\\d{8}$" title="مثال: 05XXXXXXXX"></label></div>
          <div class="inp"><label>ملاحظات (اختياري)<textarea name="notes" rows="3" placeholder="أي تفاصيل إضافية"></textarea></label></div>

          <!-- حقول خفية للإرسال -->
          <input type="hidden" name="product" id="productField">
          <input type="hidden" name="variant" id="variantField">
          <input type="hidden" name="unit_price" id="unitPriceField">
          <input type="hidden" name="quantity" id="qtyField">
          <input type="hidden" name="total" id="totalField">
          <input type="hidden" name="shipping_method" id="shipField">
          <input type="hidden" name="shipping_note" id="shipNoteField">
          <input type="hidden" name="card_to" id="cardToField">
          <input type="hidden" name="card_msg" id="cardMsgField">
          <input type="hidden" name="card_from" id="cardFromField">

          <div class="summary" aria-live="polite">
            <div class="row">
              <div class="meta">الإجمالي</div>
              <div id="summaryTotal" class="total">199 ر.س</div>
            </div>
            <div class="cta" style="margin-top:10px">
              <button id="submitBtn" class="btn" type="submit" data-mode="send" style="background:linear-gradient(135deg,var(--bg),var(--bg2));">إرسال الطلب</button>
              <span class="muted">يتحوّل الزر إلى «ادفع الآن» بعد اكتمال البيانات.</span>
            </div>
            <div class="success" id="okMsg" style="margin-top:8px">تم إرسال الطلب بنجاح، سنعود إليك قريبًا.</div>
            <div class="error" id="noMsg" style="margin-top:8px">تعذر الإرسال الآن. جرّب لاحقًا.</div>
          </div>
        </form>
      </div>

      <!-- يمين: ملاحظات -->
      <div class="panel" style="min-height:120px">
        <h2 style="margin-top:0">ملاحظات سريعة</h2>
        <p class="muted">اختر البوكس، حدِّد الكمية، أضف بطاقة الإهداء (اختياري)، اختر طريقة الشحن وأدخل بيانات التوصيل. الملخص وزر الإجراء بالأسفل.</p>
      </div>
    </div>
  </main>

  <footer>
    <div class="wrap">
      <div>© 2025 واعي كيدز – جميع الحقوق محفوظة</div>
      <nav class="foot-links"><a href="index.html">العودة للرئيسية</a></nav>
    </div>
  </footer>

  <!-- واتساب -->
  <div class="wa">
    <a aria-label="تواصل واتساب" href="https://wa.me/966570905999" target="_blank" rel="noopener">
      <svg viewBox="0 0 32 32" aria-hidden="true" focusable="false">
        <circle cx="16" cy="16" r="16" fill="#25D366"/>
        <path fill="#fff" d="M21.6 10.4a7.3 7.3 0 0 0-12.5 7.2L8 24l6.5-1.1a7.3 7.3 0 0 0 7-12.5Zm-5.5 11.7c-1.2 0-2.4-.3-3.5-.9l-.2-.1-2.1.4.6-2.1-.1-.2a6 6 0 1 1 5.3 2.9Zm3-4.4c-.2-.1-1-.5-1.2-.5-.2-.1-.3 0-.4.2l-.5.7c-.1.1-.2.2-.4.1-.7-.2-2.5-1.2-3.4-3-.1-.2 0-.3 .1-.4l.3-.3c.1-.1.1-.2.2-.3 0-.1 0-.2-.1-.4 0-.1-.5-1.3-.7-1.7-.2-.4-.4-.3-.5-.3h-.3c-.1 0-.3.1-.5.3-.2.2-.6.6-.6 1.5s.6 1.8.7 1.9c.1.1 1 1.8 2.6 2.6.9.4 1.6.6 2 .7.5.1.9.1 1.2.1.4-.1 1.1-.4 1.2-.8.1-.4.1-.7.1-.8s-.1-.2-.3-.3Z"/>
      </svg>
    </a>
  </div>

  <script>
    // الأسعار/الصور
    const PRICES = { boy:199, girl:209 };
    const IMGS = {
      boy: ["assets/boxes/boy-1-600.webp","assets/boxes/boy-2-600.webp"],
      girl: ["assets/boxes/girl-1-600.webp","assets/boxes/girl-2-600.webp"]
    };

    // عناصر أساسية
    const params = new URLSearchParams(location.search);
    const initialItem = params.get('item') || localStorage.getItem('waaiCartItem') || 'boy';

    const itemName = document.getElementById('itemName');
    const unitPriceEl = document.getElementById('unitPrice');
    const qtyEl = document.getElementById('qty');
    const summaryTotalEl = document.getElementById('summaryTotal');
    const variantRadios = document.querySelectorAll('input[name="variant"]');

    const productField = document.getElementById('productField');
    const variantField = document.getElementById('variantField');
    const unitPriceField = document.getElementById('unitPriceField');
    const qtyField = document.getElementById('qtyField');
    const totalField = document.getElementById('totalField');

    const shipRadios = document.querySelectorAll('input[name="shipping"]');
    const shipNote = document.getElementById('shipNote');
    const shipField = document.getElementById('shipField');
    const shipNoteField = document.getElementById('shipNoteField');

    const orderForm = document.getElementById('orderForm');
    const submitBtn = document.getElementById('submitBtn');

    // سلايدر مصغّر
    const slider = document.getElementById('itemSlider');
    const imgA = document.getElementById('imgA');
    const imgB = document.getElementById('imgB');
    let sliderTimer = null, sliderIdx = 0;
    function startMiniSlider(){ stopMiniSlider(); sliderTimer = setInterval(()=>{ sliderIdx=(sliderIdx+1)%2; if(sliderIdx===0){ imgA.classList.add('active'); imgB.classList.remove('active'); } else { imgB.classList.add('active'); imgA.classList.remove('active'); } }, 3000); }
    function stopMiniSlider(){ if(sliderTimer){ clearInterval(sliderTimer); sliderTimer=null; } }
    slider.addEventListener('mouseenter', stopMiniSlider);
    slider.addEventListener('mouseleave', startMiniSlider);
    function applyVariantImages(v){ const [a,b]=IMGS[v]; imgA.src=a; imgB.src=b; imgA.classList.add('active'); imgB.classList.remove('active'); sliderIdx=0; startMiniSlider(); }

    function formatSAR(n){ return `${n.toLocaleString('ar-EG')} ر.س`; }

    function setVariant(v){
      const isGirl = v==='girl';
      itemName.textContent = isGirl ? 'بوكس هدية بنات' : 'بوكس هدية أولاد';
      unitPriceEl.textContent = formatSAR(PRICES[v]);
      localStorage.setItem('waaiCartItem', v);
      applyVariantImages(v);
      updateTotals();
    }

    function updateTotals(){
      const v = document.querySelector('input[name="variant"]:checked').value;
      const q = Math.max(1, parseInt(qtyEl.value||'1',10));
      const unit = PRICES[v];
      const tot = unit * q;
      summaryTotalEl.textContent = formatSAR(tot);
      productField.value = itemName.textContent;
      variantField.value = v;
      unitPriceField.value = unit;
      qtyField.value = q;
      totalField.value = tot;
      updateCTA();
    }

    function updateShipping(){
      const v = document.querySelector('input[name="shipping"]:checked').value;
      if(v==='aramex'){
        shipNote.innerHTML = '✅ تم اختيار: <strong>أرامكس</strong> — التوصيل خلال 3 أيام عمل.';
        shipField.value = 'Aramex (3 business days)';
        shipNoteField.value = 'الرياض: أرامكس خلال 3 أيام عمل';
      }else{
        shipNote.innerHTML = '⚡ تم اختيار: <strong>التوصيل السريع</strong> — مندوب كيدز خلال 24 ساعة.';
        shipField.value = 'Kids Express (24h courier)';
        shipNoteField.value = 'الرياض: مندوب كيدز خلال 24 ساعة';
      }
      updateCTA();
    }

    // بطاقة الإهداء
    const giftToggle = document.getElementById('giftToggle');
    const giftArea = document.getElementById('giftArea');
    const toInput = document.getElementById('toInput');
    const msgInput = document.getElementById('msgInput');
    const fromInput = document.getElementById('fromInput');
    const themeSelect = document.getElementById('themeSelect');
    const toTxt = document.getElementById('toTxt');
    const msgTxt = document.getElementById('msgTxt');
    const fromTxt = document.getElementById('fromTxt');
    const count = document.getElementById('count');
    const card = document.getElementById('card');

    giftToggle.addEventListener('change', ()=>{ giftArea.style.display = giftToggle.checked ? 'block' : 'none'; });
    [toInput,msgInput,fromInput].forEach(el=> el && el.addEventListener('input', syncCard));
    themeSelect && themeSelect.addEventListener('change', applyTheme);

    function syncCard(){
      const v = themeSelect.value;
      toTxt.textContent   = toInput.value  ? `إلى ${toInput.value}` : (v==='girl'?'إلى أميرتنا الصغيرة 💖':'إلى أميرنا الصغير 💙');
      msgTxt.textContent  = msgInput.value || 'نتمنى لك أيامًا سعيدة مليئة بالمرح! 🎉';
      fromTxt.textContent = fromInput.value ? `من: ${fromInput.value}` : 'من: عائلتك';
      if(count) count.textContent = msgInput.value.length;
      updateCTA();
    }
    function applyTheme(){
      const v = themeSelect.value;
      card.style.background = v==='girl' ? 'linear-gradient(135deg,#fff0f6,#fff7fb)' : 'linear-gradient(135deg,#eaf2ff,#f7f9ff)';
      syncCard();
    }

    // اكتمال البيانات = تحويل الزر إلى "ادفع الآن"
    function formBasicsValid(){
      const reqOk = [...orderForm.querySelectorAll('[required]')].every(i=> i.value && (i.checkValidity?.() ?? true));
      const qtyOk = parseInt(qtyEl.value||'0',10) >= 1;
      const shipOk = !!document.querySelector('input[name="shipping"]:checked');
      return reqOk && qtyOk && shipOk;
    }
    function updateCTA(){
      if(formBasicsValid()){
        submitBtn.textContent = 'ادفع الآن';
        submitBtn.dataset.mode = 'pay';
      }else{
        submitBtn.textContent = 'إرسال الطلب';
        submitBtn.dataset.mode = 'send';
      }
    }

    // تهيئة
    variantRadios.forEach(r=> r.addEventListener('change', ()=> setVariant(r.value)));
    qtyEl.addEventListener('input', updateTotals);
    shipRadios.forEach(r=> r.addEventListener('change', updateShipping));
    (function init(){
      setVariant(initialItem);
      updateShipping();
      updateCTA();
    })();

    // طباعة/نسخ البطاقة
    document.getElementById('printBtn').addEventListener('click', ()=> window.print());
    document.getElementById('copyBtn').addEventListener('click', async ()=>{
      const txt = `${toTxt.textContent}\n\n${msgTxt.textContent}\n\n${fromTxt.textContent}`;
      try{ await navigator.clipboard.writeText(txt); alert('تم نسخ النص ✔'); }catch(_){ alert('تعذر النسخ، انسخ يدويًا.'); }
    });

    // Placeholder Apple Pay
    async function startApplePay(){
      if(window.ApplePaySession){
        alert('Apple Pay سيتاح قريبًا — سيتم تحويلك للدفع عند التفعيل ✅');
      }else{
        alert('سيتم تفعيل الدفع عبر Apple قريبًا. حاليًا يمكنك إرسال الطلب فقط 🙏');
      }
    }

    // إرسال/دفع
    async function submitOrder(ev){
      ev.preventDefault();
      // حقول البطاقة إن فُعّلت
      document.getElementById('cardToField').value   = giftToggle.checked ? toTxt.textContent   : '';
      document.getElementById('cardMsgField').value  = giftToggle.checked ? msgTxt.textContent  : '';
      document.getElementById('cardFromField').value = giftToggle.checked ? fromTxt.textContent : '';

      if(submitBtn.dataset.mode === 'pay'){ return startApplePay(), false; }

      // وضع الإرسال العادي (Formspree/Backend)
      const endpoint = orderForm.dataset.endpoint;
      const btn = submitBtn, ok = document.getElementById('okMsg'), no = document.getElementById('noMsg');
      ok.style.display='none'; no.style.display='none'; btn.disabled = true; btn.textContent = '... جارٍ الإرسال';

      const data = Object.fromEntries(new FormData(orderForm).entries());
      try{
        const res = await fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/json','Accept':'application/json'},body:JSON.stringify(data)});
        if(res.ok){ orderForm.reset(); ok.style.display='block'; localStorage.removeItem('waaiCartItem'); updateCTA(); summaryTotalEl.textContent = formatSAR(PRICES['boy']); }
        else{ no.style.display='block'; }
      }catch(_){ no.style.display='block'; }
      finally{ btn.disabled=false; updateCTA(); }
      return false;
    }
  </script>
</body>
</html>
