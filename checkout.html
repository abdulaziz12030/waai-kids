<!doctype html><html lang="ar" dir="rtl"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ø§Ù„Ø³Ù„Ø© | ÙˆØ§Ø¹ÙŠ ÙƒÙŠØ¯Ø²</title>
<link rel="stylesheet" href="css.css">
<style>
  .muted{color:var(--muted);font-size:.95em}
</style>
</head><body>
<header>
  <div class="container nav">
    <div class="brand"><img class="logo" src="images/logo.png" alt=""><strong>waai-kids.sa</strong></div>
    <a class="cart-link" href="checkout.html" aria-label="Ø§Ù„Ø³Ù„Ø©">ğŸ›ï¸ <span class="bubble" data-cart-count>0</span></a>
  </div>
</header>

<main class="container" style="padding:18px 0">
  <!-- Ù‡ÙˆÙŠØ© -->
  <section style="padding:0 0 18px">
    <div class="pill" style="background:#eaf9ff;border-color:#d9f1fb;color:#0f4663">ğŸ§¸ ÙˆØ§Ø¹ÙŠ ÙƒÙŠØ¯Ø² â€¢ Ù„Ø­Ø¸Ø§ØªÙƒ Ù…Ø¹ Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯ ØªØ¨Ø¯Ø£ Ù…Ù† Ù‡Ù†Ø§</div>
  </section>

  <div class="card" data-reveal><div class="body" style="display:grid;gap:16px" id="formArea">
    <h2>Ø§Ù„Ø³Ù„Ø©</h2>

    <div id="list" style="display:grid;gap:10px"></div>
    <div style="margin-top:4px">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <strong id="total">0</strong> Ø±.Ø³</div>

    <!-- Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¥Ù‡Ø¯Ø§Ø¡ -->
    <div id="giftBox" class="gift-preview" style="display:none">
      <div class="gift-brand">
        <img src="images/logo.png" alt="ÙˆØ§Ø¹ÙŠ ÙƒÙŠØ¯Ø²"><strong>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¥Ù‡Ø¯Ø§Ø¡</strong>
      </div>
      <div class="gift-frame">
        <canvas id="giftCanvas" width="1400" height="820" aria-label="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©"></canvas>
      </div>
      <div class="gift-actions">
        <button class="ghost" id="downloadGift">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙƒØµÙˆØ±Ø©</button>
        <button class="btn" id="shareGift">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ + Ø§Ù„ØµÙˆØ±Ø© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</button>
      </div>
      <div class="muted">Ø¥Ù† Ù„Ù… ÙŠØ¯Ø¹Ù… Ø¬Ù‡Ø§Ø²Ùƒ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¨Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­: Ø³Ù†Ø­Ù…Ù‘Ù„ Ø§Ù„ØµÙˆØ±Ø© ÙˆÙ†ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø§Ù„Ù†Øµ ÙÙ‚Ø· (Ø«Ù… Ø£Ø±ÙÙ‚ Ø§Ù„ØµÙˆØ±Ø© ÙŠØ¯ÙˆÙŠÙ‹Ø§).</div>
    </div>

    <div class="pill">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ§Ù„Ø¹Ù†ÙˆØ§Ù†</div>
    <input class="ghost" id="c-name"  placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
    <input class="ghost" id="c-phone" placeholder="Ø§Ù„Ø¬ÙˆØ§Ù„">
    <input class="ghost" id="c-city"  placeholder="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©">
    <input class="ghost" id="c-area"  placeholder="Ø§Ù„Ø­ÙŠ">
    <textarea class="ghost" id="c-addr" rows="2" placeholder="ÙˆØµÙ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø§Ù„Ø´Ø§Ø±Ø¹ØŒ Ø¹Ù„Ø§Ù…Ø© Ù…Ù…ÙŠØ²Ø©..)"></textarea>

    <div class="actions">
      <a class="btn" id="waText">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù†ØµÙ‹Ø§ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</a>
      <a class="ghost" href="product.html">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</a>
    </div>
  </div></div>
</main>

<footer>
  <div class="container">
    <div>Â© <span id="y"></span> ÙˆØ§Ø¹ÙŠ ÙƒÙŠØ¯Ø²</div>
  </div>
</footer>

<a class="wa" href="https://wa.me/966552794082" aria-label="ÙˆØ§ØªØ³Ø§Ø¨">
  <svg viewBox="0 0 32 32" width="28" height="28"><circle cx="16" cy="16" r="16" fill="#25D366"/></svg>
</a>

<script type="module">
  import { Cart, WA_NUM, initReveal } from './js/cart.js';
  initReveal();
  document.getElementById('y').textContent = new Date().getFullYear();
  Cart.renderBadge();

  const listEl = document.getElementById('list');
  const totalEl = document.getElementById('total');
  const giftBox = document.getElementById('giftBox');
  const canvas = document.getElementById('giftCanvas');
  const ctx = canvas.getContext('2d');

  let lastGift = null;

  function fmt(n){ return new Intl.NumberFormat('ar-SA').format(n); }

  function render(){
    const items = Cart.get();
    listEl.innerHTML = '';
    let total = 0;
    lastGift = null;

    items.forEach((x, i) => {
      const sum = x.price * x.qty; total += sum;

      const row = document.createElement('div');
      row.className = 'card';
      row.innerHTML = `
        <div class="body" style="display:grid;gap:8px">
          <strong>${x.name}</strong>
          ${x.gift ? `<div class="pill">Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¥Ù‡Ø¯Ø§Ø¡</div>` : ''}
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
            <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label>
            <input type="number" min="1" value="${x.qty}" style="width:90px" class="ghost" data-qty="${i}">
            <button class="ghost" data-del="${i}">Ø­Ø°Ù</button>
          </div>
          <div>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <strong>${sum}</strong> Ø±.Ø³</div>
          ${x.gift ? `<div class="muted">Ø§Ù„Ø§Ø³Ù…: ${x.gift.name||'-'} â€” Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ${x.gift.msg||'-'} â€” Ù…Ù†: ${x.gift.from||'-'}</div>` : ''}
        </div>`;
      listEl.appendChild(row);

      if (x.gift) lastGift = { ...x.gift, productName: x.name };
    });

    totalEl.textContent = fmt(total);

    listEl.querySelectorAll('[data-qty]').forEach(inp=>{
      inp.onchange = () => {
        const idx = +inp.dataset.qty;
        const it = Cart.get();
        it[idx].qty = Math.max(1, parseInt(inp.value||'1',10));
        Cart.set(it); render();
      };
    });
    listEl.querySelectorAll('[data-del]').forEach(btn=>{
      btn.onclick = () => {
        const idx = +btn.dataset.del;
        const it = Cart.get();
        it.splice(idx,1);
        Cart.set(it); render();
      };
    });

    if(lastGift){ giftBox.style.display = ''; drawGiftCard(lastGift); }
    else { giftBox.style.display = 'none'; }
  }

  // Ø±Ø³Ù… Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¥Ù‡Ø¯Ø§Ø¡ â€” Ø¥Ø¨Ø±Ø§Ø² Ù‡ÙˆÙŠØ© ÙˆØ§Ø¹ÙŠ ÙƒÙŠØ¯Ø²
  function drawGiftCard(gift){
    const DPR = Math.max(1, Math.floor(devicePixelRatio || 1));
    const baseW = 1400, baseH = 820;
    canvas.width = baseW * DPR; canvas.height = baseH * DPR;
    canvas.style.width = baseW + 'px'; canvas.style.height = baseH + 'px';
    ctx.setTransform(DPR,0,0,DPR,0,0);

    // Ø®Ù„ÙÙŠØ© ÙˆÙ‡ÙˆÙŠØ©
    const grd = ctx.createLinearGradient(0,0,0,baseH);
    grd.addColorStop(0,'#f6fbff'); grd.addColorStop(1,'#ffffff');
    ctx.fillStyle = grd; ctx.fillRect(0,0,baseW,baseH);
    roundRect(20,20,baseW-40,baseH-40,26,'#ffffff','#e9f1f5');

    // Ø²Ø®Ø§Ø±Ù Ù„Ø·ÙŠÙØ© Ø¨Ù‡ÙˆÙŠØ© ÙˆØ§Ø¹ÙŠ
    ctx.globalAlpha = .22;
    ctx.fillStyle = '#a6e4db'; circle(baseW-160,140,110);
    ctx.fillStyle = '#3aa6d0'; circle(160,baseH-140,90);
    ctx.globalAlpha = 1;

    // Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ
    ctx.fillStyle = '#0f3d5b'; ctx.fillRect(20,20,baseW-40,68);
    ctx.fillStyle = '#ffffff'; ctx.font = '700 30px system-ui'; ctx.textAlign='right';
    ctx.fillText('ÙˆØ§Ø¹ÙŠ ÙƒÙŠØ¯Ø² â€¢ Ø¨Ø·Ø§Ù‚Ø© Ø¥Ù‡Ø¯Ø§Ø¡', baseW-50, 65);

    // Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬
    ctx.fillStyle = '#256581'; ctx.font = '600 22px system-ui'; ctx.textAlign='right';
    ctx.fillText(gift.productName || 'Ù‡Ø¯ÙŠØ© Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯', baseW-50, 110);

    // Ù†ØµÙˆØµ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
    const nameLine = (gift.name || '').trim() || 'Ù„Ù„Ù…ÙˆÙ„ÙˆØ¯Ø© Ø§Ù„Ø¬Ù…ÙŠÙ„Ø©';
    const msgLine  = (gift.msg  || '').trim()  || 'Ù†ÙˆØ±ØªÙ Ø§Ù„Ø¯Ù†ÙŠØ§ ÙŠØ§ Ø£Ø¬Ù…Ù„ Ø§Ù„Ø¹Ø·Ø§ÙŠØ§';
    const fromLine = (gift.from || '').trim() || 'Ù…Ø­Ø¨ØªÙƒÙ…';

    ctx.textAlign = 'center';
    ctx.fillStyle = '#0e1a22';
    ctx.font = '800 48px system-ui';
    ctx.fillText(nameLine, baseW/2, 300);

    ctx.fillStyle = '#33434f';
    wrapText(msgLine, baseW/2, 380, baseW-260, 38, '600 32px system-ui');

    ctx.fillStyle = '#0f3d5b';
    ctx.font = '700 28px system-ui';
    ctx.fillText('â€” ' + fromLine + ' â€”', baseW/2, 560);

    // ÙˆØ³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹
    ctx.fillStyle = '#6a7c88';
    ctx.font = '600 18px system-ui';
    ctx.fillText('waai-kids.sa', baseW/2, baseH-60);
  }

  function circle(x,y,r){ ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); }
  function roundRect(x,y,w,h,r,fill='#fff',stroke='#e9f1f5'){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y,   x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x,   y+h, rr);
    ctx.arcTo(x,   y+h, x,   y,   rr);
    ctx.arcTo(x,   y,   x+w, y,   rr);
    ctx.closePath();
    ctx.fillStyle = fill; ctx.fill();
    ctx.lineWidth = 2; ctx.strokeStyle = stroke; ctx.stroke();
  }
  function wrapText(text, cx, startY, maxW, lineH, font){
    ctx.font = font; ctx.textAlign = 'center';
    const words = text.split(' '); let line = '', y = startY;
    for (let i=0;i<words.length;i++){
      const test = line ? (line + ' ' + words[i]) : words[i];
      const w = ctx.measureText(test).width;
      if(w > maxW){ ctx.fillText(line, cx, y); line = words[i]; y += lineH; }
      else line = test;
    }
    if(line) ctx.fillText(line, cx, y);
  }

  function buildWaText(){
    const items = Cart.get();
    let msg = 'Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ - ÙˆØ§Ø¹ÙŠ ÙƒÙŠØ¯Ø²%0A%0A';
    items.forEach(x=>{
      const sum=x.price*x.qty;
      msg += `â€¢ ${x.name} Ã— ${x.qty} = ${sum} Ø±.Ø³%0A`;
      if(x.gift){
        msg += `   Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¥Ù‡Ø¯Ø§Ø¡:%0A`;
        msg += `   - Ø§Ù„Ø§Ø³Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: ${encodeURIComponent(x.gift.name||'-')}%0A`;
        msg += `   - Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ${encodeURIComponent(x.gift.msg||'-')}%0A`;
        msg += `   - Ù…Ù†: ${encodeURIComponent(x.gift.from||'-')}%0A%0A`;
      }
    });
    msg += `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${Cart.total()} Ø±.Ø³%0A%0A`;
    const n=(document.getElementById('c-name').value||'').trim();
    const p=(document.getElementById('c-phone').value||'').trim();
    const city=(document.getElementById('c-city').value||'').trim();
    const area=(document.getElementById('c-area').value||'').trim();
    const addr=(document.getElementById('c-addr').value||'').trim();
    msg += `Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„:%0AØ§Ù„Ø§Ø³Ù…: ${encodeURIComponent(n)}%0AØ§Ù„Ø¬ÙˆØ§Ù„: ${encodeURIComponent(p)}%0AØ§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${encodeURIComponent(city)}%0AØ§Ù„Ø­ÙŠ: ${encodeURIComponent(area)}%0AØ§Ù„Ø¹Ù†ÙˆØ§Ù†: ${encodeURIComponent(addr)}%0A`;
    return msg;
  }

  async function shareGiftWithWhatsApp(){
    if(!lastGift){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø© Ø¥Ù‡Ø¯Ø§Ø¡ ÙÙŠ Ø§Ù„Ø³Ù„Ø©'); return; }
    const blob = await new Promise(res => canvas.toBlob(res,'image/png',0.95));
    const file = new File([blob], 'gift-card.png', {type:'image/png'});
    const text = decodeURIComponent(buildWaText().replace(/%0A/g, '\n'));

    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
      try{ await navigator.share({ files:[file], text, title:'Ø·Ù„Ø¨ ÙˆØ§Ø¹ÙŠ ÙƒÙŠØ¯Ø²' }); }catch(_){}
    } else {
      downloadBlob(blob, 'gift-card.png');
      location.href = 'https://wa.me/'+WA_NUM+'?text=' + buildWaText();
    }
  }

  function downloadBlob(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  }

  document.getElementById('downloadGift').onclick = async ()=>{
    if(!lastGift){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø© Ø¥Ù‡Ø¯Ø§Ø¡'); return; }
    const blob = await new Promise(res => canvas.toBlob(res,'image/png',0.95));
    downloadBlob(blob, 'gift-card.png');
  };
  document.getElementById('shareGift').onclick = shareGiftWithWhatsApp;
  document.getElementById('waText').onclick = ()=>{ location.href = 'https://wa.me/'+WA_NUM+'?text=' + buildWaText(); };

  render();
</script>
</body></html>