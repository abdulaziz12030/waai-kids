<!doctype html><html lang="ar" dir="rtl"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ø§Ù„Ø³Ù„Ø© | ÙˆØ§Ø¹ÙŠ ÙƒÙŠØ¯Ø²</title>
<link rel="stylesheet" href="css.css">
</head><body>
<header>
  <div class="container nav">
    <div class="brand"><img class="logo" src="images/logo.png" alt=""><strong>waai-kids.sa</strong></div>
    <a class="cart-link" href="checkout.html" aria-label="Ø§Ù„Ø³Ù„Ø©">ğŸ›ï¸ <span class="bubble" data-cart-count>0</span></a>
  </div>
</header>

<main class="container" style="padding:18px 0">
  <!-- Ù‡ÙˆÙŠØ© -->
  <section style="padding:0 0 18px">
    <div class="pill" style="background:#eaf9ff;border-color:#d9f1fb;color:#0f4663" data-reveal>ğŸ§¸ ÙˆØ§Ø¹ÙŠ ÙƒÙŠØ¯Ø² â€¢ Ù„Ø­Ø¸Ø§ØªÙƒ Ù…Ø¹ Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯ ØªØ¨Ø¯Ø£ Ù…Ù† Ù‡Ù†Ø§</div>
  </section>

  <div class="card" data-reveal id="formArea"><div class="body" style="display:grid;gap:16px">
    <h2 class="fade-up">Ø§Ù„Ø³Ù„Ø©</h2>

    <div id="list" style="display:grid;gap:10px"></div>
    <div style="margin-top:4px">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <strong id="total">0</strong> Ø±.Ø³</div>

    <!-- Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¥Ù‡Ø¯Ø§Ø¡ (Ø¹Ø±Ø¶ÙŠØ©) -->
    <div id="giftBox" class="gift-preview" style="display:none">
      <div class="gift-brand">
        <img src="images/logo.png" alt="ÙˆØ§Ø¹ÙŠ ÙƒÙŠØ¯Ø²"><strong>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¥Ù‡Ø¯Ø§Ø¡</strong>
      </div>
      <div class="gift-frame" data-reveal>
        <!-- Ø¹Ø±Ø¶ÙŠØ©: Ø§Ø±ØªÙØ§Ø¹ Ø£Ù‚Ù„ Ù„ØªÙ†Ø§Ø³Ø¨ Ø§Ù„Ø¬ÙˆØ§Ù„ -->
        <canvas id="giftCanvas" width="1440" height="640" aria-label="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©"></canvas>
      </div>
      <div class="gift-actions">
        <!-- Ø²Ø± ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·: Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© -->
        <button class="btn" id="shareGift">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ + ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</button>
        <!-- Ø®ÙŠØ§Ø± Ù†Øµ ÙÙ‚Ø· (Ø§Ø­ØªÙŠØ§Ø·ÙŠ) -->
        <button class="ghost" id="waText">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù†ØµÙ‹Ø§ ÙÙ‚Ø·</button>
      </div>
      <div class="muted">Ø¥Ù† Ù„Ù… ÙŠØ¯Ø¹Ù… Ø¬Ù‡Ø§Ø²Ùƒ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¨Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­: Ø³Ù†ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø§Ù„Ù†Øµ ÙÙ‚Ø·ØŒ ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±ÙØ§Ù‚ Ø§Ù„ØµÙˆØ±Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§.</div>
    </div>

    <div class="pill">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ§Ù„Ø¹Ù†ÙˆØ§Ù†</div>
    <input class="ghost" id="c-name"  placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
    <input class="ghost" id="c-phone" placeholder="Ø§Ù„Ø¬ÙˆØ§Ù„">
    <input class="ghost" id="c-city"  placeholder="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©">
    <input class="ghost" id="c-area"  placeholder="Ø§Ù„Ø­ÙŠ">
    <textarea class="ghost" id="c-addr" rows="2" placeholder="ÙˆØµÙ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø§Ù„Ø´Ø§Ø±Ø¹ØŒ Ø¹Ù„Ø§Ù…Ø© Ù…Ù…ÙŠØ²Ø©..)"></textarea>
  </div></div>

  <section style="padding-top:12px">
    <a class="ghost" href="product.html">+ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</a>
  </section>
</main>

<footer>
  <div class="container">
    <div>Â© <span id="y"></span> ÙˆØ§Ø¹ÙŠ ÙƒÙŠØ¯Ø²</div>
  </div>
</footer>

<a class="wa" href="https://wa.me/966552794082" aria-label="ÙˆØ§ØªØ³Ø§Ø¨">
  <svg viewBox="0 0 32 32" width="28" height="28"><circle cx="16" cy="16" r="16" fill="#25D366"/></svg>
</a>

<script type="module">
  import { Cart, WA_NUM, initReveal } from './js/cart.js';
  initReveal();
  document.getElementById('y').textContent = new Date().getFullYear();
  Cart.renderBadge();

  const listEl = document.getElementById('list');
  const totalEl = document.getElementById('total');
  const giftBox = document.getElementById('giftBox');
  const canvas = document.getElementById('giftCanvas');
  const ctx = canvas.getContext('2d');

  let lastGift = null;
  let sending = false; // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±

  function fmt(n){ return new Intl.NumberFormat('ar-SA').format(n); }

  function render(){
    const items = Cart.get();
    listEl.innerHTML = '';
    let total = 0;
    lastGift = null;

    items.forEach((x, i) => {
      const sum = x.price * x.qty; total += sum;

      const row = document.createElement('div');
      row.className = 'card';
      row.setAttribute('data-reveal','');
      row.innerHTML = `
        <div class="body" style="display:grid;gap:8px">
          <strong>${x.name}</strong>
          ${x.gift ? `<div class="pill">Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¥Ù‡Ø¯Ø§Ø¡</div>` : ''}
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
            <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label>
            <input type="number" min="1" value="${x.qty}" style="width:90px" class="ghost" data-qty="${i}">
            <button class="ghost" data-del="${i}">Ø­Ø°Ù</button>
          </div>
          <div>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <strong>${sum}</strong> Ø±.Ø³</div>
          ${x.gift ? `<div class="muted">Ø§Ù„Ø§Ø³Ù…: ${x.gift.name||'-'} â€” Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ${x.gift.msg||'-'} â€” Ù…Ù†: ${x.gift.from||'-'}</div>` : ''}
        </div>`;
      listEl.appendChild(row);

      if (x.gift) lastGift = { ...x.gift, productName: x.name };
    });

    totalEl.textContent = fmt(total);

    listEl.querySelectorAll('[data-qty]').forEach(inp=>{
      inp.onchange = () => {
        const idx = +inp.dataset.qty;
        const it = Cart.get();
        it[idx].qty = Math.max(1, parseInt(inp.value||'1',10));
        Cart.set(it); render();
      };
    });
    listEl.querySelectorAll('[data-del]').forEach(btn=>{
      btn.onclick = () => {
        const idx = +btn.dataset.del;
        const it = Cart.get();
        it.splice(idx,1);
        Cart.set(it); render();
      };
    });

    if(lastGift){ giftBox.style.display = ''; drawGiftCard(lastGift); }
    else { giftBox.style.display = 'none'; }
  }

  // Ø±Ø³Ù… Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¥Ù‡Ø¯Ø§Ø¡ (Landscape Ù…Ø­Ø³Ù‘ÙÙ†Ø© Ù„Ù„Ø¬ÙˆØ§Ù„)
  function drawGiftCard(gift){
    const DPR = Math.max(1, Math.floor(devicePixelRatio || 1));
    const baseW = 1440, baseH = 640; // Ø¹Ø±Ø¶ÙŠ Ø£ÙƒØ«Ø±
    canvas.width = baseW * DPR; canvas.height = baseH * DPR;
    canvas.style.width = '100%'; canvas.style.maxWidth = baseW+'px';
    ctx.setTransform(DPR,0,0,DPR,0,0);

    // Ø®Ù„ÙÙŠØ© ÙˆÙ‡ÙˆÙŠØ©
    const grd = ctx.createLinearGradient(0,0,0,baseH);
    grd.addColorStop(0,'#f6fbff'); grd.addColorStop(1,'#ffffff');
    ctx.fillStyle = grd; ctx.fillRect(0,0,baseW,baseH);

    // Ù„ÙˆØ­Ø© Ø¯Ø§Ø®Ù„ÙŠØ©
    roundRect(18,18,baseW-36,baseH-36,24,'#ffffff','#e9f1f5');

    // Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ Ø±ÙÙŠØ¹ + Ù†Ù‚Ø§Ø· Ø²Ø®Ø±ÙÙŠØ©
    ctx.fillStyle = '#0f3d5b'; ctx.fillRect(18,18,baseW-36,56);
    ctx.globalAlpha = .20;
    ctx.fillStyle = '#a6e4db'; circle(baseW-120,115,80);
    ctx.fillStyle = '#3aa6d0'; circle(110,baseH-120,68);
    ctx.globalAlpha = 1;

    // Ø¹Ù†Ø§ÙˆÙŠÙ†
    ctx.fillStyle = '#ffffff';
    ctx.font = '700 28px system-ui'; ctx.textAlign='right';
    ctx.fillText('ÙˆØ§Ø¹ÙŠ ÙƒÙŠØ¯Ø² â€¢ Ø¨Ø·Ø§Ù‚Ø© Ø¥Ù‡Ø¯Ø§Ø¡', baseW-50, 56);

    ctx.fillStyle = '#256581';
    ctx.font = '600 22px system-ui'; ctx.textAlign='right';
    ctx.fillText(gift.productName || 'Ù‡Ø¯ÙŠØ© Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯', baseW-50, 100);

    // Ù†ØµÙˆØµ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
    const nameLine = (gift.name || '').trim() || 'Ù„Ù„Ù…ÙˆÙ„ÙˆØ¯Ø© Ø§Ù„Ø¬Ù…ÙŠÙ„Ø©';
    const msgLine  = (gift.msg  || '').trim()  || 'Ù†ÙˆØ±ØªÙ Ø§Ù„Ø¯Ù†ÙŠØ§ ÙŠØ§ Ø£Ø¬Ù…Ù„ Ø§Ù„Ø¹Ø·Ø§ÙŠØ§';
    const fromLine = (gift.from || '').trim() || 'Ù…Ø­Ø¨ØªÙƒÙ…';

    ctx.textAlign = 'center';
    ctx.fillStyle = '#0e1a22';
    ctx.font = '800 44px system-ui';
    ctx.fillText(nameLine, baseW/2, 260);

    ctx.fillStyle = '#33434f';
    wrapText(msgLine, baseW/2, 330, baseW-240, 36, '600 30px system-ui');

    ctx.fillStyle = '#0f3d5b';
    ctx.font = '700 26px system-ui';
    ctx.fillText('â€” ' + fromLine + ' â€”', baseW/2, 480);

    // ÙˆØ³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹
    ctx.fillStyle = '#6a7c88';
    ctx.font = '600 18px system-ui';
    ctx.fillText('waai-kids.sa', baseW/2, baseH-40);
  }

  function circle(x,y,r){ ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); }
  function roundRect(x,y,w,h,r,fill='#fff',stroke='#e9f1f5'){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y,   x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x,   y+h, rr);
    ctx.arcTo(x,   y+h, x,   y,   rr);
    ctx.arcTo(x,   y,   x+w, y,   rr);
    ctx.closePath();
    ctx.fillStyle = fill; ctx.fill();
    ctx.lineWidth = 2; ctx.strokeStyle = stroke; ctx.stroke();
  }
  function wrapText(text, cx, startY, maxW, lineH, font){
    ctx.font = font; ctx.textAlign = 'center';
    const words = text.split(' '); let line = '', y = startY;
    for (let i=0;i<words.length;i++){
      const test = line ? (line + ' ' + words[i]) : words[i];
      const w = ctx.measureText(test).width;
      if(w > maxW){ ctx.fillText(line, cx, y); line = words[i]; y += lineH; }
      else line = test;
    }
    if(line) ctx.fillText(line, cx, y);
  }

  function buildWaText(){
    const items = Cart.get();
    let msg = 'Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ - ÙˆØ§Ø¹ÙŠ ÙƒÙŠØ¯Ø²%0A%0A';
    items.forEach(x=>{
      const sum=x.price*x.qty;
      msg += `â€¢ ${x.name} Ã— ${x.qty} = ${sum} Ø±.Ø³%0A`;
      if(x.gift){
        msg += `   Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¥Ù‡Ø¯Ø§Ø¡:%0A`;
        msg += `   - Ø§Ù„Ø§Ø³Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: ${encodeURIComponent(x.gift.name||'-')}%0A`;
        msg += `   - Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ${encodeURIComponent(x.gift.msg||'-')}%0A`;
        msg += `   - Ù…Ù†: ${encodeURIComponent(x.gift.from||'-')}%0A%0A`;
      }
    });
    msg += `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${Cart.total()} Ø±.Ø³%0A%0A`;
    const n=(document.getElementById('c-name').value||'').trim();
    const p=(document.getElementById('c-phone').value||'').trim();
    const city=(document.getElementById('c-city').value||'').trim();
    const area=(document.getElementById('c-area').value||'').trim();
    const addr=(document.getElementById('c-addr').value||'').trim();
    msg += `Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„:%0AØ§Ù„Ø§Ø³Ù…: ${encodeURIComponent(n)}%0AØ§Ù„Ø¬ÙˆØ§Ù„: ${encodeURIComponent(p)}%0AØ§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${encodeURIComponent(city)}%0AØ§Ù„Ø­ÙŠ: ${encodeURIComponent(area)}%0AØ§Ù„Ø¹Ù†ÙˆØ§Ù†: ${encodeURIComponent(addr)}%0A`;
    return msg;
  }

  async function shareGiftWithWhatsApp(){
    if(sending) return; sending = true;
    const btn = document.getElementById('shareGift');
    btn.disabled = true; const prev = btn.textContent; btn.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ø¶ÙŠØ±â€¦';

    try{
      if(!lastGift){
        // Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø©: Ø§ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø§Ù„Ù†Øµ ÙÙ‚Ø·
        location.href = 'https://wa.me/'+WA_NUM+'?text=' + buildWaText();
        return;
      }
      const blob = await new Promise(res => canvas.toBlob(res,'image/png',0.95));
      const file = new File([blob], 'gift-card.png', {type:'image/png'});
      const text = decodeURIComponent(buildWaText().replace(/%0A/g, '\n'));

      if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share({ files:[file], text, title:'Ø·Ù„Ø¨ ÙˆØ§Ø¹ÙŠ ÙƒÙŠØ¯Ø²' });
      } else {
        // fallback: Ù†Øµ ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ù„ØªØ¨Ø³ÙŠØ· Ø§Ù„ØªØ¬Ø±Ø¨Ø© ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª)
        location.href = 'https://wa.me/'+WA_NUM+'?text=' + buildWaText();
      }
    }catch(_){
      alert('ØªØ¹Ø°Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¤Ù‚ØªÙ‹Ø§');
    }finally{
      // Ù†Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¨Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø²Ø± Ø¨Ø¹Ø¯ 8 Ø«ÙˆØ§Ù†Ù ÙÙ‚Ø· Ø¥Ù† Ø¨Ù‚ÙŠ ÙÙŠ Ø§Ù„ØµÙØ­Ø©
      setTimeout(()=>{ sending=false; btn.disabled=false; btn.textContent=prev; }, 8000);
    }
  }

  document.getElementById('shareGift').onclick = shareGiftWithWhatsApp;
  document.getElementById('waText').onclick = ()=>{
    if(sending) return; sending = true;
    const tbtn = document.getElementById('waText'); const prev = tbtn.textContent;
    tbtn.disabled = true; tbtn.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„ÙØªØ­â€¦';
    location.href = 'https://wa.me/'+WA_NUM+'?text=' + buildWaText();
    setTimeout(()=>{ sending=false; tbtn.disabled=false; tbtn.textContent=prev; }, 8000);
  };

  render();
  function render(){
    const items = Cart.get();
    listEl.innerHTML = '';
    let total = 0;
    lastGift = null;

    items.forEach((x, i) => {
      const sum = x.price * x.qty; total += sum;
      const row = document.createElement('div');
      row.className = 'card'; row.setAttribute('data-reveal','');
      row.innerHTML = `
        <div class="body" style="display:grid;gap:8px">
          <strong>${x.name}</strong>
          ${x.gift ? `<div class="pill">Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¥Ù‡Ø¯Ø§Ø¡</div>` : ''}
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
            <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label>
            <input type="number" min="1" value="${x.qty}" style="width:90px" class="ghost" data-qty="${i}">
            <button class="ghost" data-del="${i}">Ø­Ø°Ù</button>
          </div>
          <div>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <strong>${sum}</strong> Ø±.Ø³</div>
          ${x.gift ? `<div class="muted">Ø§Ù„Ø§Ø³Ù…: ${x.gift.name||'-'} â€” Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ${x.gift.msg||'-'} â€” Ù…Ù†: ${x.gift.from||'-'}</div>` : ''}
        </div>`;
      listEl.appendChild(row);
      if (x.gift) lastGift = { ...x.gift, productName: x.name };
    });

    totalEl.textContent = fmt(total);

    listEl.querySelectorAll('[data-qty]').forEach(inp=>{
      inp.onchange = () => {
        const idx = +inp.dataset.qty;
        const it = Cart.get();
        it[idx].qty = Math.max(1, parseInt(inp.value||'1',10));
        Cart.set(it); render();
      };
    });
    listEl.querySelectorAll('[data-del]').forEach(btn=>{
      btn.onclick = () => {
        const idx = +btn.dataset.del;
        const it = Cart.get();
        it.splice(idx,1);
        Cart.set(it); render();
      };
    });

    if(lastGift){ giftBox.style.display = ''; drawGiftCard(lastGift); }
    else { giftBox.style.display = 'none'; }
  }
</script>
</body></html>